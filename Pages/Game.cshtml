@page
@model GameModel
@{
    ViewData["Title"] = "Game";
    var game = Model.CurrentGame;
}

@if (game is null)
{
    <p>No game in progress.</p>
}
else
{
    <div class="mb-3">
        @foreach (var p in game.Players)
        {
            <span class="me-3"><strong>@p.Name</strong>: @p.Score</span>
        }
    </div>

    @if (Model.NextTile != null)
    {
        <div class="mb-3">
            <div class="tile tile-@Model.NextTile.Type.ToString().ToLower()" id="nextTile">@Model.NextTile.Type.ToString()[0]</div>
            <button id="rotateBtn" class="btn btn-secondary btn-sm mt-2">Rotate</button>
        </div>
        <form method="post" id="placeForm">
            <input type="hidden" asp-for="X" />
            <input type="hidden" asp-for="Y" />
            <input type="hidden" asp-for="Rotation" />
        </form>
    }
    else
    {
        <p>Deck empty. Game over.</p>
    }

    var minX = game.PlacedTiles.Any() ? game.PlacedTiles.Min(t => t.X) - 1 : -1;
    var maxX = game.PlacedTiles.Any() ? game.PlacedTiles.Max(t => t.X) + 1 : 1;
    var minY = game.PlacedTiles.Any() ? game.PlacedTiles.Min(t => t.Y) - 1 : -1;
    var maxY = game.PlacedTiles.Any() ? game.PlacedTiles.Max(t => t.Y) + 1 : 1;
    <table class="board">
    @for (var y = maxY; y >= minY; y--)
    {
        <tr>
        @for (var x = minX; x <= maxX; x++)
        {
            var tile = game.PlacedTiles.FirstOrDefault(t => t.X == x && t.Y == y);
            <td class="board-cell @(tile == null ? "empty" : "")" data-x="@x" data-y="@y">
                @if (tile != null)
                {
                    <div class="tile tile-@tile.Type.ToString().ToLower()" style="transform:rotate(@(tile.Rotation)deg)">@tile.Type.ToString()[0]</div>
                }
            </td>
        }
        </tr>
    }
    </table>
}

@section Scripts {
<script>
let rotation = 0;
const rotateBtn = document.getElementById('rotateBtn');
rotateBtn?.addEventListener('click', e => {
    e.preventDefault();
    rotation = (rotation + 90) % 360;
    document.getElementById('Rotation').value = rotation;
    document.getElementById('nextTile').style.transform = `rotate(${rotation}deg)`;
});

document.querySelectorAll('.board-cell.empty').forEach(cell => {
    cell.addEventListener('click', () => {
        document.getElementById('X').value = cell.dataset.x;
        document.getElementById('Y').value = cell.dataset.y;
        document.getElementById('placeForm').submit();
    });
});
</script>
}
